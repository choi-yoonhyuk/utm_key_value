<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>UTM 옵션 마스터 목록 (파라미터 활성화 관리)</title>
<style>
    body { font-family: sans-serif; margin: 20px; font-size: 14px; }
    .button-container { margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; } 
    .button-container button { padding: 10px 15px; font-size: 1em; cursor: pointer; background-color: #007bff; color: white; border: none; border-radius: 5px; }
    .button-container button:hover { background-color: #0056b3; }
    .button-container button#saveParameterStatusButton { background-color: #28a745; } /* 저장 버튼 녹색 */
    .button-container button#saveParameterStatusButton:hover { background-color: #218838; }

    table { width: 100%; border-collapse: collapse; margin-top: 20px; table-layout: fixed; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; vertical-align: top; word-wrap: break-word; }
    th { background-color: #f0f0f0; position: sticky; top: 0; z-index: 1;}
    th label { display: flex; align-items: center; font-weight: normal; }
    th label input[type="checkbox"] { margin-right: 5px; cursor: pointer; } /* 토글 스위치 스타일 */
    #loadingStatus { font-style: italic; color: #777; margin-bottom: 15px; }
    #tableContainerWrapper { max-height: 70vh; overflow-y: auto; border: 1px solid #ddd; }
    .status-message { margin-top: 10px; padding: 10px; border-radius: 4px; display: none; }
    .status-message.success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .status-message.error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
</style>
</head>
<body>
<div class="button-container">
    <button onclick="location.href='https://choi-yoonhyuk.github.io/source_medium_drop/'">UTM 빌더로 이동</button>
    <button id="saveParameterStatusButton">파라미터 활성 상태 저장</button>
</div>
<h1>UTM 옵션 마스터 목록</h1>
<p id="loadingStatus">데이터 로딩 중...</p>
<div id="statusMessage" class="status-message"></div>
<div id="tableContainerWrapper">
    <div id="optionsTableContainer"></div>
</div>

<script>
    // 1. "옵션 마스터 시트"의 CSV 웹 게시 URL
    const MASTER_OPTIONS_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vShcppno7HuVQbjoQzbaBMEvoBGt6atss9FI_-F3qSh_pzgtxw7A4NPo6Y2EYoll2y5_8wMt08X_oV0/pub?gid=1861589139&single=true&output=csv';
    // 2. Google Sheet 상태 업데이트를 위한 n8n 웹훅 URL (사용자 실제 URL로 변경 필수)
    const N8N_WEBHOOK_URL_FOR_STATUS_UPDATE = 'https://entrench-consulting.app.n8n.cloud/webhook-test/15daaf64-30ee-4b32-9426-45a8c8bd9184';

    const parameterToggles = new Map(); // 파라미터명과 토글 DOM 요소를 매핑

    document.addEventListener('DOMContentLoaded', async () => {
        const loadingStatusEl = document.getElementById('loadingStatus');
        const tableContainerEl = document.getElementById('optionsTableContainer');
        const saveButton = document.getElementById('saveParameterStatusButton');
        const statusMessageEl = document.getElementById('statusMessage');


        if (!MASTER_OPTIONS_CSV_URL || MASTER_OPTIONS_CSV_URL.startsWith('여기에_')) {
            loadingStatusEl.textContent = "오류: 구글 시트 CSV URL이 설정되지 않았습니다.";
            loadingStatusEl.style.color = "red";
            saveButton.disabled = true;
            return;
        }
        if (!N8N_WEBHOOK_URL_FOR_STATUS_UPDATE || N8N_WEBHOOK_URL_FOR_STATUS_UPDATE.startsWith('여기에_')) {
            console.warn("N8N 웹훅 URL이 설정되지 않았습니다. '저장' 기능이 정상 동작하지 않을 수 있습니다.");
            // saveButton.disabled = true; // 필요시 주석 해제
        }
        
        saveButton.addEventListener('click', handleSaveParameterStatus);

        try {
            loadingStatusEl.textContent = "옵션 목록 로딩 중...";
            const response = await fetch(MASTER_OPTIONS_CSV_URL, { cache: 'no-cache' }); 
            if (!response.ok) throw new Error(`마스터 옵션 CSV 로드 실패 (상태 코드: ${response.status})`);
            const csvDataText = await response.text(); 
            if (!csvDataText.trim()) {
                loadingStatusEl.textContent = "옵션 데이터가 비어있거나 가져올 수 없습니다.";
                tableContainerEl.innerHTML = '<p>표시할 옵션 데이터가 없습니다.</p>';
                return;
            }

            const tableElement = createOrganizedTableFromCsv(csvDataText, ['type']); // 'type' 컬럼 숨기기
            tableContainerEl.innerHTML = ''; 
            tableContainerEl.appendChild(tableElement); 
            loadingStatusEl.style.display = 'none'; 

        } catch (error) {
            console.error("마스터 옵션 로딩 또는 표시 오류:", error);
            loadingStatusEl.textContent = `오류: ${error.message}`;
            loadingStatusEl.style.color = "red";
            tableContainerEl.innerHTML = '<p>옵션 목록을 불러오는 데 실패했습니다.</p>';
        }
    });

    function displayStatusMessage(message, isSuccess) {
        const statusMessageEl = document.getElementById('statusMessage');
        statusMessageEl.textContent = message;
        statusMessageEl.className = 'status-message ' + (isSuccess ? 'success' : 'error');
        statusMessageEl.style.display = 'block';
        setTimeout(() => { statusMessageEl.style.display = 'none'; }, 5000);
    }

    async function handleSaveParameterStatus() {
        const loadingStatusEl = document.getElementById('loadingStatus');
        const saveButton = document.getElementById('saveParameterStatusButton');
        saveButton.disabled = true;
        loadingStatusEl.textContent = "파라미터 상태 저장 중...";
        loadingStatusEl.style.display = 'block';

        const statusPayload = {};
        parameterToggles.forEach((toggleElement, paramName) => {
            // key_is_active 형태로 만듭니다.
            statusPayload[`${paramName}_is_active`] = toggleElement.checked ? 'Y' : 'N';
        });

        console.log("Sending to n8n for Google Sheet update:", statusPayload);

        if (!N8N_WEBHOOK_URL_FOR_STATUS_UPDATE || N8N_WEBHOOK_URL_FOR_STATUS_UPDATE.startsWith('여기에_')) {
            displayStatusMessage("오류: N8N 웹훅 URL이 설정되지 않아 저장할 수 없습니다.", false);
            loadingStatusEl.style.display = 'none';
            saveButton.disabled = false;
            return;
        }

        try {
            const response = await fetch(N8N_WEBHOOK_URL_FOR_STATUS_UPDATE, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(statusPayload)
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`n8n 저장 요청 실패 (${response.status}): ${errorText || '알 수 없는 오류'}`);
            }
            const result = await response.json(); // n8n에서 응답이 있다면 파싱
            console.log("n8n response:", result);
            displayStatusMessage("파라미터 활성 상태가 n8n으로 전송되었습니다. (Google Sheet 업데이트는 n8n 워크플로우 확인 필요)", true);

        } catch (error) {
            console.error("Error saving parameter status to n8n:", error);
            displayStatusMessage(`오류 발생: ${error.message}`, false);
        } finally {
            loadingStatusEl.style.display = 'none';
            saveButton.disabled = false;
        }
    }


    function createOrganizedTableFromCsv(csvDataText, headersToHide = []) {
        parameterToggles.clear(); // 이전 토글 참조 초기화
        const lines = csvDataText.split(/\r?\n/).filter(line => line.trim() !== "");
        const table = document.createElement('table');

        if (lines.length === 0) {
            table.innerHTML = '<tr><td>표시할 데이터가 없습니다 (CSV 비어있음).</td></tr>';
            return table;
        }

        const allCsvHeaders = lines[0].split(',').map(header => header.trim().replace(/^"|"$/g, ''));
        const csvDataRows = lines.slice(1);
        
        const originalHeaderIndexMap = new Map();
        allCsvHeaders.forEach((header, index) => originalHeaderIndexMap.set(header, index));

        const lowerCaseHeadersToHide = headersToHide.map(h => h.toLowerCase());
        
        // 실제 파라미터(값 컬럼)와 해당 파라미터의 활성화 상태를 저장할 객체
        const parametersData = {}; 

        allCsvHeaders.forEach((headerName) => {
            if (headerName.endsWith('_is_active')) return; // 상태 컬럼은 건너뜀
            if (lowerCaseHeadersToHide.includes(headerName.toLowerCase())) return; // 숨길 컬럼 건너뜀

            const statusColumnName = `${headerName}_is_active`;
            const statusColumnIndex = originalHeaderIndexMap.get(statusColumnName);
            let isActive = 'Y'; // 기본값: 활성화

            if (statusColumnIndex !== undefined && csvDataRows.length > 0) {
                const firstDataRowCells = csvDataRows[0].split(',').map(cell => cell.trim().replace(/^"|"$/g, ''));
                if (firstDataRowCells.length > statusColumnIndex && firstDataRowCells[statusColumnIndex]) {
                    const statusValue = firstDataRowCells[statusColumnIndex].toUpperCase();
                    isActive = (statusValue === 'Y' || statusValue === 'TRUE' || statusValue === '1') ? 'Y' : 'N';
                }
            }
            parametersData[headerName] = { initialStatus: isActive, options: new Set() };
        });
        
        const displayHeaders = Object.keys(parametersData);

        const thead = table.createTHead();
        const headerRow = thead.insertRow();
        displayHeaders.forEach(headerText => {
            const th = document.createElement('th');
            const label = document.createElement('label');
            const toggleCheckbox = document.createElement('input');
            toggleCheckbox.type = 'checkbox';
            toggleCheckbox.checked = parametersData[headerText].initialStatus === 'Y';
            toggleCheckbox.dataset.paramName = headerText; // '저장' 시 이 값을 사용

            label.appendChild(toggleCheckbox); // 레이블 내부에 체크박스(토글)를 먼저 추가
            label.appendChild(document.createTextNode(" " + headerText)); // 그 뒤에 파라미터 이름 텍스트 추가
            th.appendChild(label); // 레이블을 th에 추가
            headerRow.appendChild(th);
            parameterToggles.set(headerText, toggleCheckbox); // Map에 파라미터 이름과 토글 요소 저장
        });

        // 옵션 값들 채우기
        displayHeaders.forEach(headerText => {
            const originalColIndex = originalHeaderIndexMap.get(headerText);
            if (originalColIndex !== undefined) {
                csvDataRows.forEach(line => {
                    const cells = line.split(',').map(cell => cell.trim().replace(/^"|"$/g, ''));
                    if (cells.length > originalColIndex && cells[originalColIndex]) {
                        const value = String(cells[originalColIndex]).trim();
                        if (value && value.toLowerCase() !== 'undefined') {
                            parametersData[headerText].options.add(value);
                        }
                    }
                });
            }
        });

        let maxOptionsCount = 0;
        displayHeaders.forEach(header => {
            if (parametersData[header] && parametersData[header].options.size > maxOptionsCount) {
                maxOptionsCount = parametersData[header].options.size;
            }
        });
        
        const tbody = table.createTBody();
        if (maxOptionsCount === 0 && displayHeaders.length > 0) {
            const tr = tbody.insertRow();
            const td = tr.insertCell();
            td.colSpan = displayHeaders.length || 1;
            td.textContent = "모든 카테고리에 유효한 옵션 값이 없습니다."; 
            td.style.textAlign = "center";
        } else if (displayHeaders.length === 0) {
            const tr = tbody.insertRow();
            const td = tr.insertCell();
            td.textContent = "표시할 컬럼이 없습니다.";
            return table; // 테이블 반환 전에 tbody는 있어야 함
        }

        for (let i = 0; i < maxOptionsCount; i++) { 
            const tr = tbody.insertRow();
            displayHeaders.forEach(header => {
                const td = tr.insertCell();
                const optionsForThisHeaderArray = Array.from(parametersData[header].options || new Set()); 
                let cellValue = optionsForThisHeaderArray[i] || ""; 

                if (cellValue === undefined || String(cellValue).trim().toLowerCase() === 'undefined') {
                    td.textContent = ""; 
                } else {
                    td.textContent = String(cellValue).trim(); 
                }
            });
        }
        return table;
    }
</script>
</body>
</html>